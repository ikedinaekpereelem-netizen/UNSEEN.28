import React, { useState, useContext, useEffect } from 'react';
import { AuthContext } from '../AuthContext';

export default function AdminWalletPanel() {
  const { token, isAdmin, email, username } = useContext(AuthContext);
  const [txns, setTxns] = useState([]);
  const [userId, setUserId] = useState('');
  const [amount, setAmount] = useState('');
  const [destination, setDestination] = useState('');
  const [msg, setMsg] = useState('');

  // Only admin can access
  if (!(isAdmin && email === "officialmanagementbookings3@gmail.com" && username === "UNSEENutc")) {
    return <div>Admin wallet access only.</div>;
  }

  useEffect(() => {
    fetch('/api/wallet/txns', {
      headers: { Authorization: 'Bearer ' + token }
    })
      .then(res => res.json())
      .then(setTxns);
  }, [token, msg]);

  const approveTxn = async (id) => {
    const res = await fetch(`/api/admin/wallet/approve/${id}`, {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + token }
    });
    const data = await res.json();
    setMsg(data.message);
  };

  const createWithdrawal = async (e) => {
    e.preventDefault();
    setMsg('');
    const res = await fetch('/api/wallet/withdraw', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ userId, amount, destination }),
    });
    const data = await res.json();
    setMsg(data.message);
  };

  return (
    <section>
      <h2>Admin Panel: Manual Withdrawals</h2>
      <form onSubmit={createWithdrawal}>
        <input placeholder="User ID" value={userId} onChange={e => setUserId(e.target.value)} required />
        <input placeholder="Amount" type="number" value={amount} onChange={e => setAmount(e.target.value)} required />
        <input placeholder="Destination (bank/paypal/etc)" value={destination} onChange={e => setDestination(e.target.value)} required />
        <button type="submit">Create Withdrawal</button>
      </form>
      <div>{msg}</div>
      <h3>Pending Transactions</h3>
      <ul>
        {txns.map(txn => (
          <li key={txn._id}>
            {txn.type} ${txn.amount} for user {txn.userId.username} | status: {txn.status}
            {txn.status === 'pending' && (
              <button onClick={() => approveTxn(txn._id)}>Approve & Process</button>
            )}
          </li>
        ))}
      </ul>
    </section>
  );
}